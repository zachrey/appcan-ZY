<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../css/ui-box.css">
        <link rel="stylesheet" href="../css/ui-base.css">
        <link rel="stylesheet" href="../css/ui-color.css">
        <link rel="stylesheet" href="../css/appcan.icon.css">
        <link rel="stylesheet" href="../css/appcan.control.css">
        <link rel="stylesheet" href="css/yqq_cgrk.css">
        <link rel="stylesheet" type="text/css" href="css/wkf.css"/>
        <script src="../js/init.js"></script>
    </head>
    <body class="um-vp" ontouchstart>
        <div  class="ub ub-f1 ub-ver yqq-xxk uc-a uinn umar-a " style="margin-bottom: 1em">  
              <div class="ub yqq-w10" >
                 <div  id="staDel" class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w w-click">工位</div>
                 <div  id="station" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc wkf-hh wkf-font-w w-click"></div>
              </div>
              <div  class="ub yqq-w10" >
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w">&diams;工序</div>
                 <div  id="process" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-w w-click"></div>
              </div>
              <div  class="ub yqq-w10" >
                 <div  id="invDel" class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w w-click">单别</div>
                 <div  id="invoices" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-w w-click"></div>
              </div>
              <div  class="ub yqq-w10" >
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w">入库日期</div>
                 <div  id="date" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc wkf-hh wkf-font-w"></div>
              </div>
        </div>
        <div  class="ub ub-f1 ub-ver yqq-xxk uc-a uinn umar-a " style="margin-bottom: 1em">  
              <div class="ub yqq-w10" >
                 <div  id="warDel" class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w w-click">库位</div>
                 <div  id="warehouseNum" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc wkf-hh wkf-font-w w-click"></div>
              </div>
              <div  class="ub yqq-w10" >
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w">仓库</div>
                 <div  id="warehouse" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-w"></div>
              </div>
              <div  class="ub yqq-w10" >
                 <div  id="vesDel" class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w w-click">容器条码</div>
                 <div  id="vesselCode" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-w "></div>
              </div>
              <div  class="ub yqq-w10" id="weight" style="display: none !important;">
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w w-click">容器重量</div>
                 <div  id="containerWei" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-w "></div>
              </div>
              <div  class="ub yqq-w10" >
                 <div  id="purNumDel" class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w w-click">品号</div>
                 <div  id="purNum" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-w "></div>
              </div>
              <div  class="ub yqq-w10" >
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w w-click">品名</div>
                 <div  id="purName" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-w "></div>
              </div>
              <div  class="ub yqq-w10" >
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w w-click">规格</div>
                 <div  id="purSta" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-w"></div>
              </div>
              <div  class="ub yqq-w10" >
                  <div class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w">
                      <div  id="count"class="ub">数量</div>
                      <div  id="unit" class="ub wkf-font-r">(公斤)</div>
                  </div>
                  <div  class="ub ub-f1 umar-l yqq-bbd ub-ac ub-pc wkf-font-z">
                     <input onkeyup="this.value=this.value.replace(/[^\d{1,}\.\d{1,}|\d{1,}]/g,'')" type="number" id="amount" name=""  class="wkf-input-nob wkf-font-w" style="width:98%;text-align:center;border:none; height: 2.2em;" value="" placeholder="请手动输入"/ >
                 </div>
              </div>
        </div>
        
        <div id="down" class="ub ub-f1 ub-ver yqq-xxk uc-a uinn umar-a " style="margin-bottom: 2em;color:white;">
              <div id="" class="ub ub-f1">
                  <div class="ub wkf-font-w umar-l uinn">物料条码</div>
                  <div class="ub ub-f1 ub-pe">
                      <div class="ub uinn uc-a" id="deleteBarcoe" style="background-color: #2B6576">删除</div>
                  </div>
              </div>
              <div id="bar_append" class="wkf-hh1">
              </div>
              <!-- <label onclick="openNum('9900001173')"> 9900001173&nbsp;&nbsp;</label> -->
       </div>
        
    </body>
    <script src="../js/appcan.js"></script>
    <script src="../js/appcan.control.js"></script>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/locStorageModify.js"></script>
    </body>
    <script>
        var ListContainerMaterialInstanceObj=[];
        //避免重复，条码数组
        var barcodeArr = [];
        //当前组的条码
        var barcodeArrNow = [];
        //全部物料条码信息
        var barcodeBaseInfo = [];
        //存入请求得到的库位信息对象
        var wareHouseJD;
        //存入请求得到的工位信息对象
        var stationJD;
        //存入请求得到的容器信息对象
        var ContainerJD;
        //容器带出的物料信息对象
        var goodsObj = {};
        //存入请求得到的工序信息对象
        var processJD;
        //存入请求得到的单别信息对象
        var invoicesJD;
        //容器实例的对象
        var ContainerObj
        //存储名字
        var LOGIN = appcan.locStorage.val('LOGIN');
        //存入请求得到的工单信息对象
        var workorderJD;
        //存入请求得到的总计信息对象
        var detailJD = [];
        //当前打开的窗口名字
        var winNameNow = '';
        //提交数组
        var ARRSUBMIT = []; 
        var tdDate = new Date();
        var tY=tdDate.getFullYear(),
            tM=tdDate.getMonth()+1,
            tD=tdDate.getDate();
        var LOGIN = appcan.locStorage.getVal("LOGIN");
        LOGIN = JSON.parse( LOGIN ); 
        appcan.ready(function() {
             stationAjax(LOGIN.StationID);
             appcan.initBounce();
            //设置当前时间
            tdDate=tY+'-'+tM+'-'+tD;
            $("#date").html( tdDate );
            //日期插件回调
            uexControl.cbOpenDatePicker = function (opId,dataType,data) {
                var oData=eval('('+data+')');
                $("#date").html(oData.year+'/'+oData.month+'/'+oData.day);   
            }
        });
        
        //日期时间按钮监听
        appcan.button('#date','ani-act',function(){
            uexControl.openDatePicker(tY,tM,tD);
        });
        
        //得到条码
        function getData( barcode ){
            if($("#station").html() == null || $("#station").html() == ""){
                 stationAjax( barcode );
            }else if($("#process").html() == null || $("#process").html() == ""){
                 appcan.window.openToast('请选择工序！',1000,5,0);
                 return;
            }else if($("#invoices").html() == null || $("#invoices").html() == ""){
                appcan.window.openToast('请选择单别！',1000,5,0);
                 return; 
            }else if($("#warehouseNum").html() == null || $("#warehouseNum").html() == ""){
                 warehouseNumAjax( barcode );
            }else if($("#vesselCode").html() == null || $("#vesselCode").html() == ""){
                 vesselCodeAjax( barcode );
            }
        }
        //工位
        function stationAjax( barcode ){
            appcan.request.ajax({
                url:"http://10.101.55.73/fzzy/SPEngine/Barcode",
                type:"POST",
                data:{
                    input:{
                        "OpType":"扫码",
                        "WorkLocationBarcode":barcode,
                        "LogicType":"工位管理"
                    } 
                },
                dataType:"json",
                success:function(info){
                    // console.log(JSON.stringify(info));
                    if(!info.bSuccess){
                        appcan.window.openToast(info.Error,3000,5,0);
                        return;
                    }
                    if(info.ifStationBarcode){
                        stationJD = info.WorkLocationInfo;
                        $('#station').html(info.WorkLocationInfo.StationName);
                        $('#process').html('');
                        if(info.WorkLocationProcessList.length === 1){
                            processJD = info.WorkLocationProcessList[0];
                            $('#process').html(info.WorkLocationProcessList[0].ProcessName);
                        }
                        //如果不是一条数据，则选进行本地存储，便于选择。
                        appcan.locStorage.val('PROCESSLIST',info.WorkLocationProcessList);
                        
                        $('html,body').animate({scrollTop:$('#station').offset().top-80},1000);
                    }else{
                        appcan.window.openToast(info.Error,1000,5,0);
                        return;
                    }
                },
                error:function(e){
                     appcan.window.openToast('网络请求错误！',1000,5,0);
                }
            });
        }
        //库位
        function warehouseNumAjax(barcode){
            appcan.request.ajax({
                url:"http://10.101.55.73/fzzy/SPEngine/Barcode",
                type:"POST",
                data:{
                    input:{
                        LogicType:"扫码",
                        ScanType:"库位精确查询",
                        StoreLocationInput:{
                            AlibraryBarcode:barcode
                        }
                    }
                },
                dataType:"json",
                success : function( info ) {
                    //appcan.window.alert((JSON.stringify(info)));
                    if(info.bSuccess){
                        var arr = info.StoreLocationOutput.Alibrary;
                        wareHouseJD = info.StoreLocationOutput.Alibrary;
                        $("#warehouseNum").html(arr.AlibraryName);
                        $("#warehouse").html(arr.WarehouseName);
                        $('html,body').animate({scrollTop:$('#warehouseNum').offset().top-80},1000);
                    }else{
                        appcna.window.openToast(info.Error,1000,5,0);
                        return;
                    }
                },
                error: function(){
                    appcan.window.openToast("网络请求错误！",1000,5,0);
                }
            })
        }
        
        //容器条码
        function vesselCodeAjax(barcode){
            if(barcodeArr.indexOf(barcode)  !== -1){
                appcan.window.openToast('容器码扫描重复！',1000,5,0);
                return;
            }
            appcan.ajax({
                url:"http://10.101.55.73/fzzy/SPEngine/Barcode",
                type:"POST",
                data:{
                   input:{
                        LogicType:"扫码",
                        scanType:"通用扫码",
                        barcode:barcode
                    }
                },
                dataType:"json",
                success:function(info){
                    // appcan.window.alert((JSON.stringify(info)));
                    if(!info.bSuccess){
                        appcan.window.openToast(info.Error,3000,5,0);
                        return;
                    }
                    if(info.BarcodeType != "1" ){
                        appcan.window.openToast('该条码不为容器码！',1000,5,0);
                        return ;
                    }
                    if(info.BarcodeInfo.materialbarcodeList != null && info.BarcodeInfo.materialbarcodeList.length != 0){
                        $("#weight").slideToggle();
                        $('#vesselCode').html(info.BarcodeInfo.container.ContainerBarCode);
                        $('#containerWei').html(info.BarcodeInfo.container.ContainerWeight);
                        ContainerJD = info.BarcodeInfo.container;
                        ContainerObj = info.BarcodeInfo.materialbarcode;
                        //避免重复
                        barcodeArr.push(barcode);
/*--------------------------------------------------------------------------------------------------------------------*/                     
                        var arr = info.BarcodeInfo.materialbarcodeList;
                        barcodeArrNow = arr;
                        appcan.locStorage.val('GOODSOBJ',arr);
                        var length = arr.length;
                        if(length == 1){
                           $('#purNum').html(arr[0].MaterialID);
                           $('#purName').html(arr[0].MatName);
                           $('#purSta').html(arr[0].Specifications);  
                           //$("#unit").html(arr[0].Company);
                           goodsObj = info.BarcodeInfo.materialbarcodeList[0];
                        }
/*--------------------------------------------------------------------------------------------------------------------*/                     
                    }else{
                       // var msg = info.ContainerBarcodeOutput['Error'];
                       appcan.window.openToast('容没有被实例化！',1000,5,0); 
                    }
                },
                error:function(a,b,c,msg){
                    // appcan.window.alert('123',msg);
                    appcan.window.openToast('网络请求错误！',1000,5,0);
                }
            })
        }
        
        appcan.button('.w-click','ani-act',function(){
            switch(this.id){
                case 'station':{
                    openWindow('station');
                    break;
                }
                    
                case 'process':{
                    if($('#station').html() == ''){
                        appcan.window.openToast('请先选择工位！',1000,5,0);
                        return;
                    }
                    openWindow('process');
                    break;
                }
                case 'invoices':{
                     openWindow('invoices');
                    break;
                }
                case 'warehouseNum':{
                    openWindow('warehouseNum');
                    break;
                }
                case 'vesselCode':{
                    openWindow('materialCode');
                    break;
                }
                case 'purNum':{
                    openWindow('purNumber');
                    break;
                }
                case 'staDel':{
                    //stationAjax('9900001480');
                     $("#station").html("");
                    $("#process").html("");
                    break;
                }
                case 'invDel':{
                    if($('#invoices').html() == ''){
                        $('#invoices').html('/');
                    }else{
                        $('#invoices').html('');
                    }
                    //invoicesAjax('123456');
                    break;
                }
                // case 'worDel':{
                    // //workorderAjax('9900001561');
                    // break;
                // }
                case 'warDel':{
                     $("#warehouseNum").html("");
                     $("#warehouse").html("");
                    //warehouseNumAjax('9900001501');
                     break;
                }
                case 'vesDel':{
                     // $("#vesselCode").html("");
                    // $("#purNum").html("");
                     // $("#purName").html("");
                     // $("#purSta").html("");
                    vesselCodeAjax('9900001450');
                    break;
                }
            }
        });
        //打开窗口
        function openWindow( name ){
            localOption.localSave( 'copin'+name );
            winNameNow = name;
            appcan.window.open({
                name:'copin'+name,
                data:name+'.html',
            })
        }
         //各个窗口的回调
        function openWindowBack( info ){
            //appcan.window.alert(info)
            info = eval('('+info+')');
            switch(winNameNow){
                case 'station':
                    stationAjax(info.StationBarcode);
                    break;
                case 'process':
                    processJD = info;
                    $('#process').html(info.ProcessName);
                    $('html,body').animate({scrollTop:$('#process').offset().top-80},1000);
                    break;
                case 'invoices':
                    invoicesJD = info;
                    $('#invoices').html(info.Name);
                    $('html,body').animate({scrollTop:$('#invoices').offset().top-80},1000);
                    break;
                case 'warehouseNum':
                    wareHouseJD = info;
                    $('#warehouseNum').html(info.AlibraryName);
                    $('#warehouse').html(info.WarehouseName);
                    $('html,body').animate({scrollTop:$('#warehouseNum').offset().top-80},1000);
                    break;
                    // //do some thing 
                    // break;
            }
        }
        
        //保存
        function groupSave(){
            var json = {};
            var warehouseNum = $('#warehouseNum'),
                warehouse = $('#warehouse'),
                vesselCode = $('#vesselCode'),
                goodsId = $("#purNum"),
                goodsName = $("#purName"),
                goodsStander = $("#purSta"),
                Amount = $("#amount"),
                Unit = $("#uint");
               
            if(warehouseNum.html()=='' || warehouse.html()==''|| vesselCode.html()==''||Amount.val()==""){
                appcan.window.openToast('请先完善信息！',1000,5,0);
                return;
            }
            var str = '<li style="display:inline-block;">'+$("#vesselCode").html()+'&nbsp;&nbsp;</li>';
            $('#bar_append').prepend(str);
            
            
            //存入准备展示的数据
            detailJD.push({
                warehouseNum:warehouseNum.html(),
                warehouse:warehouse.html(),
                vesselCode:vesselCode.html(),
                barcode:ContainerJD.ContainerBarCode,
                amount:$("#amount").val(),
                unit:$("#uint").html(),
            });
            
            var goodsJson = {
                    MaterialBarcodeGuid:goodsObj.GUID, 
                    ProductNo: $("#purNum").html(),
                    Specifications: $("#purSta").html(),
                    Amount: $("#amount").val(),
                    Unit: "公斤",
                }
            ListContainerMaterialInstanceObj.push(goodsJson);           
            var submitJson = {
                MaterialBarcodeGuid: ContainerObj.GUID,
                AlibraryBarcode:wareHouseJD.AlibraryBarcode ,
                WareBarcode: wareHouseJD.WarehouseBarcode,
                ListContainerMaterialInstance:ListContainerMaterialInstanceObj
            }
            ARRSUBMIT.push(submitJson);
            //清空
            warehouseNum.html('');
            warehouse.html('');
            vesselCode.html('');
            //Unit.html('');
            goodsId.html('');
            goodsName.html('');
            goodsStander.html('');
            Amount.val('');
            //$("#unit").html('');
            
           
            //更新主页记录数量
            appcan.window.evaluateScript({
                name:"copperInput",
                scriptContent:"modifyCount("+ARRSUBMIT.length+")"
            });
            appcan.window.openToast('保存成功！',1000,5,0);
            $('html,body').animate({scrollTop:$('#warehouseNum').offset().top-80},1000);
        }
        
        //删除当前条码
        appcan.button('#deleteBarcoe','ani-act',function(){
            $('#bar_append>:first').remove();
            barcodeArr.pop();
            ARRSUBMIT.pop();
            detailJD.pop();
            appcan.window.evaluateScript({
                name:"copperInput",
                scriptContent:"modifyCount("+ARRSUBMIT.length+")"
            });
        });
        
         //开启总计页面
       function openTotal(){
           localOption.localSave('copinamountDetail');
           appcan.locStorage.val('AMOUNTDETAILINFO',detailJD);
           appcan.window.open({
               name:"picamountDetail",
               data:"amountDetail.html"
           });
       }
       
       function copperInputSubmit(){
           if(!confirm("确定提交？")){
               return;
           }

           if(ARRSUBMIT.length === 0){
               appcan.window.openToast('当前没有信息！',1000,5,0);
               return;
           }
           appcan.window.openToast('提交中...',10000,5,1);
           var jsonData =  {
                    LogicType: "铜屑管理", 
                    OpType: "铜屑入库", 
                    StationBarcode: stationJD.StationBarcode,            //工位条码
                    ProcessID: processJD.ProcessId,     //工序编号
                    Single:(invoicesJD.ID ? invoicesJD.ID : ''),                         //单别信息,待完善
                    StorageTime: $('#date').html(), 
                    OperatorId:LOGIN.UserID,//'3556',
                    copperScrapInfoList:ARRSUBMIT
           };
           //appcan.window.alert('提示',JSON.stringify(jsonData));
           appcan.ajax({
               url:"http://10.101.55.73/fzzy/SPEngine/Barcode",
               type:"POST",
               data:{
                   input:jsonData
               },
               dataType:'json',
               success:function(info){
                   //appcan.window.alert(JSON.stringify(info));
                   if(info.bSuccess){
                       appcan.window.closeToast();
                       appcan.window.openToast('提交成功！',1000,5,0);
                       appcan.window.evaluateScript({
                            name:"copperInput",
                            scriptContent:"reload()"
                        });
                   }else{
                       appcan.window.openToast(info['Error'],1000,5,0);
                   }
               },
               error:function(e){
                   appcan.window.openToast('网络请求出错！',1000,5,0);
               }
           })
       }
    </script>
</html>

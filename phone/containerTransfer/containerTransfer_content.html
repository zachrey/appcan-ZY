<!DOCTYPE html>
<html class="um landscape min-width-240px min-width-320px min-width-480px min-width-768px min-width-1024px">
    <head>
        <title></title>
        <meta charset="utf-8">
        <meta name="viewport" content="target-densitydpi=device-dpi, width=device-width, initial-scale=1, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../css/fonts/font-awesome.min.css">
        <link rel="stylesheet" href="../css/ui-box.css">
        <link rel="stylesheet" href="../css/ui-base.css">
        <link rel="stylesheet" href="../css/ui-color.css">
        <link rel="stylesheet" href="../css/appcan.icon.css">
        <link rel="stylesheet" href="../css/appcan.control.css">   
        <link rel="stylesheet" href="css/yqq_cgrk.css">
        <link rel="stylesheet" href="css/wkf.css"/>
        <script src="../js/init.js"></script>
    </head>
    <body class="um-vp " ontouchstart>
        <div class="ub  ub-ver">
            <!-- 工位开始 -->
          <div id="" class="ub ub-f1 ub-ver yqq-xxk uc-a uinn umar-a ">  
              <div id="" class="ub yqq-w10" >
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w">工位</div>
                 <div  id="traStation" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc wkf-hh wkf-font-z w-click"></div>
              </div>
              <div id="" class="ub yqq-w10 " >
                 <div  class="ub yqq-w3  uinn yqq-bbd ub-pc ub-ac wkf-font-w">入库日期</div>
                 <div id="time" class="ub ub-f1 umar-l  yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-z"></div>
              </div>
          </div>
          <!-- 工位结束 -->
          <!--采购单号开始-->
          <div id="updataPart" class="ub ub-f1 ub-ver yqq-xxk uc-a uinn umar-a " style="margin-bottom: 1em">
              <div id="" class="ub yqq-w10" >
                 <div id="emptyoutputContainer" class="ub w-click yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w">转出容器</div>
                 <div id="outputContainer" class=" ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc wkf-hh wkf-font-z"></div>
              </div>
              <div id="" class="ub yqq-w10" >
                 <div  class="ub yqq-w3 w-click yqq-bbd uinn ub-pc ub-ac wkf-font-w">&diams;品号</div>
                 <div id="traGoodsId" class="ub ub-f1 w-click umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-z"></div>
              </div>
              <div id="" class="ub yqq-w10" >
                 <div id="dd" class="ub yqq-w3 yqq-bbd uinn  ub-pc ub-ac wkf-font-w">品名</div>
                 <div id="traGoodsName" class="ub ub-f1  umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-z"></div>
              </div>
              <div id="" class="ub yqq-w10" >
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w">规格</div>
                 <div id="traStandard" class="ub ub-f1  umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-z"></div>
              </div>
              <div id="" class="ub yqq-w10" >
                 <div id="bb"   class="ub yqq-w3  yqq-bbd uinn ub-pc ub-ac wkf-font-w">原数量<div id="unit" class="wkf-font-r"></div></div>
                 <div id="oldCount" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-z"></div>
              </div>
              <div id="" class="ub yqq-w10" >
                 <div class="ub yqq-w3 w-click yqq-bbd uinn ub-pc ub-ac wkf-font-w">转出数量<div id="unit" class="wkf-font-r"></div></div>
                 <div  class="ub ub-f1 umar-l  yqq-bbd ub-ac ub-pc wkf-font-z">
                     <input type="number" id="outputAmount" name="" type="number" class="wkf-input-nob wkf-font-w" style="width:98%;text-align:center;border:none; height: 2.2em;" value="" placeholder="请手动输入"/ >
                 </div>
              </div>
              <div id="" class="ub yqq-w10" >
                 <div id="emptyInputContainer" class="ub yqq-w3 w-click yqq-bbd uinn ub-pc ub-ac wkf-font-w">转入容器<div id="unit" class="wkf-font-r"></div></div>
                 <div id="inputContainer" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-z"></div>
              </div>
              <!-- <div id="" class="ub yqq-w10" >
                 <div  class="ub yqq-w3 yqq-bbd uinn ub-pc ub-ac wkf-font-w">物料条码</div>
                 <div id="materialCode" class="ub ub-f1 umar-l yqq-bbd uinn ub-ac ub-pc  wkf-hh wkf-font-z"></div>
              </div> -->
          </div>
          <!--采购单号结束-->
           <div id="down" class="ub ub-f1 ub-ver yqq-xxk uc-a uinn umar-a " style="margin-bottom: 2em;color:white;">
              <div id="" class="ub ub-f1">
                  <div class="ub wkf-font-w umar-l uinn">容器条码</div>
                  <div class="ub ub-f1 ub-pe">
                      <div class="ub uinn uc-a" id="deleteBarcoe" style="background-color: #2B6576">删除</div>
                  </div>
              </div>
              <div id="bar_append" class="wkf-hh1">
              </div>
              <!-- <label onclick="openNum('9900001173')"> 9900001173&nbsp;&nbsp;</label> -->
           </div>
        </div>
       
    <script src="../js/appcan.js"></script>
    <script src="../js/appcan.control.js"></script>
    <script src="../js/locStorageModify.js"></script>
    <script src="../js/jquery.min.js"></script>
    </body>
    <script>
        //全局变量 存数据
        //全部条码
        var barcodeBaseInfo = [];
        //当前组条码
        var barcodeArrNow = [];
        var clickIndex;//点击物料条码详情  数组下标
        var windowId//开窗的id
        var outContaineObj = {};//转出容器对象
        var inContaineObj = {};//转入容器对象
        var goodObj = {};//物料相关
        var detailNeed = [];//总计需要字段
        //避免重复条码扫描
        var barcodeArr = []; 
        var goodsArrNow = [];
        var LOGIN = appcan.locStorage.val('LOGIN');//存储名字
        var SourceInstanceObj = [];//转出容器物料对象 
        var SourceContanierObj = [];//转出容器；
        var TargetInstanceObj = [];//转入容器物料对象
        var TargetContanierObj = [];//转入容器；
        var partFlag = 0;//部分和整体。
        var ContainerGroupObj = [];//容器组对象
        appcan.ready(function() {
            LOGIN = eval('('+LOGIN+')');
            $("#traStation").html(LOGIN.StationName);
//      获取当前日期
            var myDate = new Date();
            $("#time").html(myDate.getFullYear()+'/'+(myDate.getMonth()+1)+'/'+myDate.getDate());   
//      日期选择器的回调   
            uexControl.cbOpenDatePicker = function (opId,dataType,data) {
                var oData=eval('('+data+')');
                $("#time").html(oData.year+'/'+oData.month+'/'+oData.day);   
            }
        });
        //开窗
        appcan.button(".w-click","ani-act",function(){
           windowId = this.id;
           //alert(windowId);
           switch( this.id ){
             case 'traStation': openWindow('traStation'); break;
             case 'traGoodsName': {
                    if($("#outputContainer").html() == ""){
                       appcan.window.openToast('请先填入转出容器！',1000,5,0);
                        return; 
                    }
                    openWindow('traGoodsName'); break};
             case 'traGoodsId': {
                    if($("#outputContainer").html() == ""){
                       appcan.window.openToast('请先填入转出容器！',1000,5,0);
                        return; 
                    }
                    openWindow('traGoodsId'); break};
             case 'traStandard': {
                    if($("#outputContainer").html() == ""){
                       appcan.window.openToast('请先填入转出容器！',1000,5,0);
                        return; 
                    }
                    openWindow('traStandard'); break};
             // case 'dd': {
                  // outputContainerAjax("9900001441"); 
                  // break; 
                 // }  
            // case 'bb': {
                  // inputContainerAjax("9900001444"); 
                  // break; 
                 // }  
             case 'emptyoutputContainer': {
                  $("#outputContainer").html("");
                  $("#traGoodsId").html("");
                  $("#traGoodsName").html("");
                  $("#traStandard").html("");
                  $("#unit").html("");
                //outputContainerAjax("9900001783"); 
                  break;
             };
             case 'emptyInputContainer': {
                  $("#inputContainer").html("");
                   // inputContainerAjax("9900001444");
                  break;
             };         
           }
        })
        //打开时间选择器
        appcan.button("#time","ani-act",function(){
            var myDate = new Date();
             uexControl.openDatePicker(myDate.getFullYear(),(myDate.getMonth()+1),myDate.getDate());   
        })
        //开窗
        function openWindow( name ){
            localOption.localSave( name );
            appcan.window.open({
                name:name,
                data:name+'.html',
                aniId:10
            })
        }
        //接受扫描数据
        function getData( Data )
        {
            if($("#outputContainer").html() == null || $("#outputContainer").html() == ""){
                 outputContainerAjax( Data );
            }else if($("#inputContainer").html()==""||$("#inputContainer").html()==null){
                     if( $('#outputAmount').val() == ''){
                        appcan.window.openToast('请先输入数量！',1000,5,0);
                        return;
                     }
                     inputContainerAjax( Data );
                    //  $("#inputContainer").html(Data);
                 }
            
        }       
       //------转出容器--->ajax
       
        function outputContainerAjax( Data ){
            //alert(123);
             if( barcodeArr.indexOf(Data) !== -1){
                 appcan.window.openToast('容器码重复!',1000,5,0);
                 return;
               }
             appcan.request.ajax({
                url:"http://10.101.55.73/fzzy/SPEngine/Barcode",
                type:"POST",
                data:{
                    input:{
                        LogicType:"扫码",
                        scanType:"通用扫码",
                        barcode:Data
                    }
                },
                dataType:"json",
                success : function( info ) {
               		if(!info.bSuccess){
                		appcan.window.openToast(info['Error'],1000,5,0);
                        return ;//直接跳过return；
                	}
                	if( info.BarcodeType != 1 && info.BarcodeType != 9 ){//扫码不为物料实例或者是容器码
                		appcan.window.openToast("该条码不为容器码或者物料实例码！",1000,5,0);
                        return ;//直接跳过return；
                	}
                    if(info.BarcodeType == 1){//容器码
                    	if(info.BarcodeInfo.materialbarcode == null ){//物料实例码没带实例
                             appcan.window.openToast('该条码未实例化',1000,5,0);
                             return ;
                    	}
                    	var arr = info.BarcodeInfo.materialbarcodeList;
                        if(arr.length == 1){
                           $("#traGoodsId").html(arr[0].MaterialID);
                           $("#traGoodsName").html(arr[0].MatName);
                           $("#traStandard").html(arr[0].Specifications); 
                           $("#oldCount").html(arr[0].Amount);
                           $("#unit").html('('+arr[0].Company+')');
                           goodObj = arr[0];
                           if(arr[0].Inspection === 1){
                               appcan.window.openToast('当前物料为送检状态，请重新扫描！',2000,5,0);return;
                           }
                        }
                        appcan.locStorage.val('INFOLIST',arr);
                        $("#outputContainer").html(info.BarcodeInfo.container.ContainerBarCode);
                        outContaineObj = info.BarcodeInfo.container;//=============================提交细化对象  两种
                        $('html,body').animate({scrollTop:$('#outputContainer').offset().top-80},1000);
                    }else if(info.BarcodeType == 9){//物料实例码
                    	if(info.BarcodeInfo.materialbarcode == null ){//物料实例码没带实例
                             appcan.window.openToast('该条码未实例化',1000,5,0);
                             return ;
                    	}
                    	var arr = info.BarcodeInfo.materialbarcode;
                           $("#traGoodsId").html(arr.MaterialID);
                           $("#traGoodsName").html(arr.MatName);
                           $("#traStandard").html(arr.Specifications); 
                           $("#oldCount").html(arr.Amount);
                           $("#unit").html('('+arr.Company+')');
                           goodObj = arr;
                           if(arr.Inspection === 1){
                               appcan.window.openToast('当前物料为送检状态，请重新扫描！',2000,5,0);return;
                           }
                        var ARR=[];
                        ARR.push(arr);   
                        appcan.locStorage.val('INFOLIST',ARR);
                        $("#outputContainer").html(info.BarcodeInfo.materialbarcode.Barcode);
                        outContaineObj = {
                        	ContainerGuid:"",
                        	ContainerBarCode:""
                        };//==============
                        $('html,body').animate({scrollTop:$('#outputContainer').offset().top-80},1000);
                    }
                },
                error: function(){
                      appcan.window.openToast("网络请求错误！",1000,5,0);
                }
            })
        }
       //--------转入容器----->ajax
        function inputContainerAjax( Data ){
            appcan.request.ajax({
                    url:"http://10.101.55.73/fzzy/SPEngine/Barcode",
                    type:"POST",
                    data:{
                        input:{LogicType:"扫码",
                        ScanType:"容器扫码",
                        ContainerBarcodeInput:{
                            "Barcode":Data,
                            }
                        }
                    },
                    dataType:"json",
                    success : function( info ) {
                        // appcan.window.alert(JSON.stringify(info));
                        if(!info.bSuccess){
                            if( !info.isFitBarcodeType  ){
                                appcan.window.openToast('不为容器码，请重新扫描！',1000,5,0);
                                return ;
                            }if(!info.ContainerBarcodeOutput.isContainerBarcodeDefined){
                        		appcan.window.openToast(info['Error'],1000,5,0);
                            	return ;//直接跳过return；
                            } 
                        }
                        $("#inputContainer").html(info.ContainerBarcodeOutput.ContainerEntity.ContainerBarCode);
                        inContaineObj = info.ContainerBarcodeOutput.ContainerEntity;
                        $('html,body').animate({scrollTop:$('#inputContainer').offset().top-80},1000);
                    },
                    error: function(){
                        appcan.window.openToast("网络请求错误！",1000,5,0);
                    }
            })
        }
        // function materialCodeAjax( Data ){
            // $("#materialCode").html( Data );
//             
            // if( barcodeArr.indexOf(Data) !== -1){
                // appcan.window.openToast('物料码重复!',1000,5,0);
                // return;
            // }
            // barcodeArr.push(Data);
            // //显示
            // var str = '<label>'+Data+'&nbsp;&nbsp;</label>'
            // $('#bar_append').prepend(str);
            // //现在就做存储
            // var json = {
                // materialCode:Data,
                // amount:$('#amount').val()
            // };
            // //将条码和数量放到当前数组
            // barcodeArrNow.push(json);
        // }
        
        //删除当前条码
        appcan.button('#deleteBarcoe','ani-act',function(){
            $('#bar_append>:first').remove();
            barcodeArr.pop();
            barcodeBaseInfo.pop();
            detailNeed.pop();
            ContainerGroupObj.pop();
            appcan.window.evaluateScript({
                name:"containerTransfer",
                scriptContent:"modifyCount("+barcodeArr.length+")"
            });
        });
        
        
       //保存数据
       function traSave(){
           if($("#outputContainer").html() == "" || $("#outputContainer").html() == null){
               appcan.window.openToast("请先添加转出容器！",1000,5,0);
               return ;
           };
           if($("#outputAmount").val() == "" || $("#outputAmount").val() == null){
               appcan.window.openToast("请先添加转出数量！",1000,5,0);
               return ;
           }
           if($("#inputContainer").html() == "" || $("#inputContainer").html() == null){
               appcan.window.openToast("请先添加转入容器！",1000,5,0);
               return ;
           }if(parseInt($("#oldCount").html(),10) < parseInt($("#outputAmount").val(),10)){
               appcan.window.openToast("转出数量不得大于原数量！",1000,5,0);
               return ;
           }else if(parseInt($("#oldCount").html(),10) == parseInt($("#outputAmount").val(),10)){
               partFlag = 1;//全部的时候
           }else if(parseInt($("#oldCount").html(),10) > parseInt($("#outputAmount").val(),10)){
               partFlag = 2;//部分的时候
           }

           // if(barcodeArr.length == 0){
               // appcan.window.openToast("无数据无法保存！",1000,5,0);
               // return ;
           // }
          appcan.window.alert({
            title:'提示',
            content:'是否保存',
            buttons:['是','否'],
            callback:function(err,data,dataType,optId){
               if( data == 0 ){
                   //准备总计显示的数据
                   Djson = {
                       outputContainer:$("#outputContainer").html(),
                       traGoodsId:$("#traGoodsId").html(),
                       traGoodsName :$("#traGoodsName").html(),
                       traStandard:$("#traStandard").html(),
                       oldCount:$("#oldCount").html(),
                       outputAmount:$("#outputAmount").val(),
                       unit:$("#unit").html(),
                       inputContainer:$("#inputContainer").html(),
                   };
                   var aomunt = $('#outputAmount').val();
                   if(partFlag == 1){                       //partFlag == 1     整个
                       var arr = {
                                    Type: "容器内物料整个拿走",
                                    Barcode:goodObj.Barcode ,
                                    Guid:goodObj.GUID,
                                    Amount: aomunt
                                 };
                       var arr1 = {
                                    Type: "扫物料条码整个加入", 
                                    Barcode: goodObj.Barcode ,
                                    Guid: goodObj.GUID,
                                    Amount: aomunt
                                  }          
                   }else if( partFlag == 2 ) {               //partFlag == 2     部分
                    var arr = {
                                Type: "容器内物料拿部分", 
                                Barcode:goodObj.Barcode ,
                                Guid:goodObj.GUID,
                                Amount: aomunt
                              };
                    var arr1 = {
                                Type: "扫物料条码拿部分", 
                                Barcode: goodObj.Barcode ,
                                Guid: goodObj.GUID,
                                Amount: aomunt
                                }             
                   }
  //----------------------------------------------------------------------                 
           //  ******* true的json的结构 ********     //  
 //----------------------------------------------------------------------- 
            //源容器    
           // alert("tianjia ")
                   SourceInstanceObj=[];
                   TargetInstanceObj=[];
                   SourceInstanceObj.push(arr);
                   TargetInstanceObj.push(arr1);
                   var ARR = {
                        SourceContainerGuid: outContaineObj.ContainerGuid,
                        SourceContainerBarcode: outContaineObj.ContainerBarCode,
                        SourceOpType: "从容器实例减少",
                        SourceInstanceList: SourceInstanceObj,
                        TargetContainerGuid: inContaineObj.ContainerGuid,
                        TargetContainerBarcode: inContaineObj.ContainerBarCode,
                        TargetOpType: "往容器实例添加",
                        TargetInstanceList: TargetInstanceObj
                    };
                    ContainerGroupObj.push(ARR);  
     //------------------------------------------------------------------
            //********** false 的json结构 **********   //
     //------------------------------------------------------------------
    
              
    //---------------------------------------------------------------------------------------- 
     
     
                   detailNeed.push(Djson);
                   appcan.window.openToast("保存成功！",1000,5,0);
                   //清空updatapart
                   console.log(JSON.stringify(TargetInstanceObj),JSON.stringify(TargetContanierObj));
                   var str = '<label>'+$("#outputContainer").html()+'&nbsp;&nbsp;</label>'
                   $("#bar_append").prepend(str);
                   barcodeArr.push($("#outputContainer").html());
                   appcan.window.evaluateScript({
                       name:"containerTransfer",
                       scriptContent:"modifyCount("+barcodeArr.length+")"
                   }); 
                   $("#outputContainer").html("");
                   $("#inputContainer").html("");
                   $("#traGoodsId").html("");
                   $("#traGoodsName").html("");
                   $("#traStandard").html("");
                   $("#oldCount").html("");
                   $("#unit").html("");
                   $("#outputAmount").val("");
                   //barcodeArrNow = [];
                   
                   $('html,body').animate({scrollTop:$('#outputContainer').offset().top-80},1000);
               }
            }
          })
       }
       function traSubmit(){//0为ture
           //alert(22);
           // alert(errsuccse);
           if(!confirm("确定提交？")){
               return;
           }

               if( detailNeed.length === 0){
               appcan.window.openToast('当前没有可提交数据！',1000,5,0);
               return;}
           appcan.window.openToast('提交中...',10000,5,1);
           //alert(0);
                var json = {
                                LogicType:"流转",
                           OpType:"容器转移",
                            ContainerMoveInput: {
                                Station:LOGIN.StationName,//存储名字
                                StationBarcode:LOGIN.StationBarcode,
                                Oprater:LOGIN.U_LoginName,
                                OpraterBarcode:LOGIN.UserID,
                                lstContainerGroup:ContainerGroupObj,
                                },
                                Ext: { }
                            }
                //appcan.window.alert('123',JSON.stringify(json));
                appcan.request.ajax({
                    url:"http://10.101.55.73/fzzy/SPEngine/Barcode",
                    type:"POST",
                    data:{
                       input:{
                           LogicType:"流转",
                           OpType:"容器转移",
                            ContainerMoveInput: {
                                Station:LOGIN.StationName,//存储名字
                                StationBarcode:LOGIN.StationBarcode,
                                Oprater:LOGIN.U_LoginName,
                                OpraterBarcode:LOGIN.UserID,
                                lstContainerGroup:ContainerGroupObj,
                                },
                                Ext: { }

                        },
                    },
                    dataType:"json",
                    success : function( info ) {
                       if(info.bSuccess){
                           appcan.window.closeToast();
                           appcan.window.openToast('提交成功！',1000,5,0);
                           //appcan.window.alert(JSON.stringify(info))
                           setTimeout(function(){
                             appcan.window.evaluateScript({
                               name:'containerTransfer',
                               scriptContent:"reload()"
                             })  
                           },1000)
                       }else{
                           appcan.window.openToast(info['Error'],3000,5,0);
                       }
                    },
                    error: function(){
                        appcan.window.openToast("网络请求错误！",1000,5,0);
                    },
               })
       }
       //删除条码记录
       // function deleteNum(deleteNum){
           // barcodeBaseInfo.splice(clickIndex,1);
           // $('#'+deleteNum).remove();
       // }
       //开窗带回函数
       function openWindowBack (Obj){
            var Obj = eval('('+Obj+')');
            // appcan.window.alert(JSON.stringify(Obj));
            switch( windowId )
            {
                case 'traStation': {
                     $("#traStation").html(Obj.StationName);
                     $('html,body').animate({scrollTop:$('#traStation').offset().top-80},1000);
                     break;
                }
                case 'traGoodsId':{
                    $("#traGoodsId").html(Obj.MaterialID);
                    $("#traGoodsName").html(Obj.MatName);
                    $("#traStandard").html(Obj.Specifications);
                    $("#oldCount").html(Obj.Amount);
                    $("#unit").html('('+Obj.Company+')');
                    goodObj = Obj;
                    $('html,body').animate({scrollTop:$('#traGoodsId').offset().top-80},1000);
                    break;
                }
               
            }
       }
       
       //开启总计页面
       function openTotal(){
           localOption.localSave('amountDetail');
           appcan.locStorage.val('AMOUNTDETAILINFO',detailNeed);
           appcan.window.open({
               name:"amountDetail",
               data:"amountDetail.html",
               aniId:10
           });
       }
        
    </script>
</html>
